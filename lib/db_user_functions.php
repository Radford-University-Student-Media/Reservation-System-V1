<?php/*Radford Reservation SystemAuthor: Andrew MeltonFilename: /lib/db_user_functions.phpPurpose:This file contains all functions related to users  in the databaseKnown Bugs/Fixes:None*//*Simply gets the proper information to process a login.*/function processDBLogin($userid){	$userid = makeStringSafe($userid);	return doQuery("SELECT user_id,password,user_level FROM ".getDBPrefix()."_users WHERE username = '".$userid."'");}/*Creates a new user and gives them a random password. It then returns that password.*/function newUserNoPassword($stuid, $name, $email, $user_level){	$stuid = makeStringSafe($stuid);	$name = makeStringSafe($name);	$email = makeStringSafe($email);	$user_level = makeStringSafe($user_level);	$password = "";		if(!getConfigVar("use_ldap")){		$password = makeStringSafe(generatePassword(9,4));;	}	doQuery("INSERT INTO ".getDBPrefix()."_users SET username = '".$stuid."', name = '".$name."', password = '".makeStringSafe(encrypt($password))."', email = '".$email."', user_level = '".$user_level."', warnings = '0'");	$user = mysql_fetch_assoc(doQuery("SELECT user_id FROM ".getDBPrefix()."_users ORDER BY user_id DESC LIMIT 1"));	logAddUser(getSessionVariable('user_id'), $user['user_id']);	return $password;}function createUserFromLDAP($username, $password){	$auth_user=$username."@".getConfigVar('ldap_domain');	if($connect=@ldap_connect(getConfigVar('ldap_server'))){		if($bind=@ldap_bind($connect, $auth_user, $password)){			$ldap_dn = "ou=people, dc=radford, dc=EDU";			$filter = "(sAMAccountName=$username)";			$result = ldap_search($connect, $ldap_dn, $filter);			$entries = ldap_get_entries($connect, $result);							$name = $entries[0]['givenname'][0]." ".$entries[0]['sn'][0];			$email = $username."@".getConfigVar('ldap_domain');							newUser($username, $name, "", $email);		}	}	@ldap_close($connect);	$userresult = getUserByUsername($username);	$user = mysql_fetch_assoc($userresult);	sendNewUserNoticeToAdmins($user['user_id']);	return $userresult;}/*Creates a new user with a provided password.*/function newUser($stuid, $name, $password, $email){	$stuid = makeStringSafe($stuid);	$name = makeStringSafe($name);	$password = makeStringSafe($password);	$email = makeStringSafe($email);	doQuery("INSERT INTO ".getDBPrefix()."_users SET username = '".$stuid."', name = '".$name."', password = '".makeStringSafe(encrypt($password))."', email = '".$email."', user_level = '".RES_USERLEVEL_NOLOGIN."', warnings = '0'");	$user = mysql_fetch_assoc(doQuery("SELECT user_id FROM ".getDBPrefix()."_users ORDER BY user_id DESC LIMIT 1"));	logAddUser(getSessionVariable('user_id'), $user['user_id']);}function changeUserPassword($userid, $newpass){	$userid = makeStringSafe($userid);	$newpass = makeStringSafe($newpass);	doQuery("UPDATE ".getDBPrefix()."_users SET password = '".makeStringSafe(encrypt($newpass))."'  WHERE user_id = ".$userid."");	logChangeUserPassword($userid);}function changeUserEmail($userid, $email){	$userid = makeStringSafe($userid);	$email = makeStringSafe($email);	doQuery("UPDATE ".getDBPrefix()."_users SET email = '".$email."'  WHERE user_id = ".$userid."");	logChangeUserEmail($userid);}function changeUserLevel($userid, $level){	$userid = makeStringSafe($userid);	$level = makeStringSafe($level);	doQuery("UPDATE ".getDBPrefix()."_users SET user_level = '".$level."'  WHERE user_id = ".$userid."");	logChangeUserEmail($userid);}function changeUserNotes($userid, $notes){	$userid = makeStringSafe($userid);	$notes = makeStringSafe($notes);	doQuery("UPDATE ".getDBPrefix()."_users SET notes= '".$notes."'  WHERE user_id = ".$userid."");	logChangeUserNotes($userid);}function getUserByID($userid){	$userid = makeStringSafe($userid);	return doQuery("SELECT * FROM ".getDBPrefix()."_users WHERE user_id = '".$userid."'");}function getUserByUsername($username){	$username = makeStringSafe($username);	return doQuery("SELECT * FROM ".getDBPrefix()."_users WHERE username = '".$username."'");}function getAllUsers(){	return doQuery("SELECT * FROM ".getDBPrefix()."_users");}function getAllUsersOrderByName(){	return doQuery("SELECT * FROM ".getDBPrefix()."_users ORDER BY name ASC");}function getAllUsersByUserLevel($level){	$level = makeStringSafe($level);	return doQuery("SELECT * FROM ".getDBPrefix()."_users WHERE user_level = '".$level."'");}function getAdmins(){	return getAllUsersByUserLevel(getConfigVar("admin_rank"));}?>